# Automated Workflow Monitoring & Fixing Setup

## Overview

This document describes the automated monitoring and fixing systems set up for CouncilWorks to proactively identify and resolve workflow failures, dependency issues, and code quality problems.

## Automated Review & Safety Controls

### Branch Protection Strategy

The automated systems use a **three-tier branch protection strategy** to ensure safety:

```
main (production) ← develop (integration) ← automated-review (safety layer) ← automated changes
```

#### Branch Roles

1. **`automated-review`** - Safety layer for all automated changes
   - All Dependabot PRs target this branch
   - All auto-fix PRs target this branch
   - All Cursor Background Agent changes target this branch
   - Requires automated review and approval

2. **`develop`** - Integration branch for reviewed changes
   - Only receives changes from `automated-review` after review
   - Manual promotion required for automated changes
   - Standard development workflow continues

3. **`main`** - Production branch
   - Only receives changes from `develop`
   - Highest level of protection and review

### Automated Review Process

#### 1. Automated Changes Creation
- **Dependabot**: Creates PRs to `automated-review` branch
- **Workflow Monitor**: Creates auto-fix PRs to `automated-review` branch  
- **Cursor Agent**: Creates PRs to `automated-review` branch

#### 2. Automated Review Workflow
The `automated-review.yml` workflow automatically:
- **Runs comprehensive tests** (TypeScript, linting, tests, build)
- **Performs security audit** for all changes
- **Detects breaking changes** and flags for manual review
- **Auto-approves safe changes** (no breaking changes, all tests pass)
- **Comments detailed review reports** on PRs

#### 3. Promotion to Develop
- **Manual Promotion**: Use workflow dispatch to promote approved changes
- **Batch Promotion**: Weekly scheduled promotion of multiple approved changes
- **Safety Checks**: All changes must pass automated review before promotion

### Safety Features

#### Branch Protection Rules
```yaml
automated-review:
  required_status_checks:
    strict: true
    contexts:
      - "test"
      - "security" 
      - "automated-review"
  required_pull_request_reviews:
    required_approving_review_count: 1
    dismiss_stale_reviews: true
```

#### Automated Safety Checks
- **Breaking Change Detection**: Flags major version updates for manual review
- **Security Audit**: Runs security checks on all changes
- **Test Coverage**: Ensures all tests pass before approval
- **Build Verification**: Confirms application builds successfully

#### Review Labels System
- `needs-review` - Requires manual review
- `approved-for-promotion` - Ready for promotion to develop
- `breaking-changes` - Contains breaking changes, manual review required
- `auto-fix` - Generated by automated systems
- `promotion` - Ready for promotion to develop

## Components

### 1. Dependabot Configuration (`.github/dependabot.yml`)

**Purpose**: Automated dependency updates and security vulnerability monitoring

**Features**:
- **Weekly Updates**: Every Monday at 9:00 AM AEST
- **Safety Branch**: All PRs target `automated-review` branch
- **Grouped Updates**: Minor and patch updates grouped together
- **Selective Major Updates**: Only for safe packages (ESLint, TypeScript ESLint)
- **Multiple Ecosystems**: npm, GitHub Actions, Docker
- **Auto-assignment**: Automatically assigned to repository owner
- **Smart Grouping**: Prevents PR spam by grouping related updates
- **Review Labels**: All PRs tagged with `needs-review` and `automated`

**Configuration**:
```yaml
# npm dependencies - weekly updates to automated-review branch
package-ecosystem: "npm"
target-branch: "automated-review"
schedule:
  interval: "weekly"
  day: "monday"
  time: "09:00"
  timezone: "Australia/Sydney"
labels:
  - "dependencies"
  - "automated"
  - "needs-review"
```

### 2. Workflow Failure Monitor (`.github/workflows/workflow-monitor.yml`)

**Purpose**: Proactive monitoring and auto-fixing of failed workflows

**Safety Features**:
- **Review Branch Targeting**: All auto-fix PRs target `automated-review` branch
- **Comprehensive Testing**: Runs full test suite before creating PRs
- **Breaking Change Detection**: Flags potential breaking changes
- **Manual Review Required**: All auto-fixes require review before promotion

**Triggers**:
- **Workflow Completion**: Monitors CI, Staging, and Production deployments
- **Scheduled Checks**: Every 6 hours
- **Manual Dispatch**: On-demand monitoring and fixing

**Auto-Fix Capabilities**:
- **Dependency Issues**: Clear cache, reinstall dependencies
- **TypeScript Errors**: Analyze and suggest fixes
- **Linting Errors**: Auto-fix with ESLint
- **Test Failures**: Analyze and provide fixes
- **Build Errors**: Clear cache, rebuild

**Smart Features**:
- **Pattern Recognition**: Identifies common failure patterns
- **Persistent Failure Detection**: Creates issues for recurring problems
- **Console Notifications**: Alerts team of critical failures
- **Auto-PR Creation**: Creates pull requests with fixes to `automated-review`

### 3. Automated Review Workflow (`.github/workflows/automated-review.yml`)

**Purpose**: Comprehensive review and promotion of automated changes

**Review Process**:
- **Comprehensive Testing**: TypeScript, linting, tests, build
- **Security Audit**: High-level security vulnerability checks
- **Breaking Change Detection**: Flags major version updates
- **Auto-Approval**: Safe changes automatically approved
- **Review Reports**: Detailed reports commented on PRs

**Promotion Features**:
- **Manual Promotion**: Workflow dispatch for immediate promotion
- **Batch Promotion**: Weekly scheduled promotion of multiple changes
- **Safety Checks**: All changes must pass review before promotion
- **Cleanup**: Automatic cleanup of old auto-fix branches

### 4. Cursor Background Agent (`.cursor/background-agent.json`)

**Purpose**: Continuous code quality improvement and automated fixes

**Safety Features**:
- **Review Branch Targeting**: All changes target `automated-review` branch
- **PR Creation**: Creates PRs for all automated fixes
- **Review Required**: All changes require review before promotion
- **Conservative Approach**: Safe fixes only, no breaking changes

**Features**:
- **Real-time Fixes**: Fixes issues as you code
- **Scheduled Maintenance**: Daily and weekly automated tasks
- **Workflow Integration**: Responds to workflow failures
- **Multi-task Support**: Handles linting, TypeScript, imports, security

**Tasks**:
- **Fix Linting Errors**: ESLint auto-fix
- **Fix TypeScript Errors**: Type checking and fixes
- **Update Imports**: Optimize import statements
- **Security Audit Fix**: Fix vulnerabilities
- **Format Code**: Prettier formatting
- **Update Dependencies**: npm update
- **Fix Test Failures**: Test analysis and fixes
- **Database Migration Fix**: Prisma migration issues
- **Build Error Fix**: Next.js build issues
- **Performance Optimization**: Code optimization

## Setup Instructions

### 1. Create Automated-Review Branch

First, create the `automated-review` branch:

```bash
# Create and push the automated-review branch
git checkout -b automated-review
git push -u origin automated-review

# Set up branch protection rules
gh api repos/:owner/:repo/branches/automated-review/protection \
  --method PUT \
  --input .github/branch-protection.yml
```

### 2. Enable Dependabot

Dependabot is automatically enabled with the configuration file. It will:
- Start creating PRs for dependency updates to `automated-review` branch
- Monitor security vulnerabilities
- Update GitHub Actions and Docker images
- All PRs will require review before promotion to develop

### 3. Configure Workflow Monitor

The workflow monitor is automatically active. To customize:

```yaml
# Enable/disable auto-fix
workflow_dispatch:
  inputs:
    auto_fix:
      description: 'Enable automatic fixing'
      default: true
      type: boolean
```

### 4. Enable Cursor Background Agent

1. **Install Cursor**: Ensure you have Cursor IDE installed
2. **Enable Background Agent**: The configuration is automatically loaded
3. **Customize Settings**: Modify `.cursor/background-agent.json` as needed
4. **Review Branch**: All changes will target `automated-review` branch

### 5. Configure Notifications

**Required Secrets**:
- `GITHUB_TOKEN`: For creating issues and PRs (automatically provided)

**Optional Secrets**:
- `SLACK_WEBHOOK_URL`: Slack webhook for notifications

## Review Workflow Process

### Daily Workflow

1. **Automated Changes Created**
   - Dependabot creates dependency update PRs
   - Workflow monitor creates auto-fix PRs
   - Cursor agent creates improvement PRs
   - All PRs target `automated-review` branch

2. **Automated Review**
   - Comprehensive tests run automatically
   - Security audits performed
   - Breaking changes detected and flagged
   - Safe changes auto-approved
   - Review reports posted on PRs

3. **Manual Review** (if needed)
   - Breaking changes require manual review
   - Complex changes may need human oversight
   - Reviewers can approve or request changes

4. **Promotion to Develop**
   - Manual promotion via workflow dispatch
   - Batch promotion weekly for multiple changes
   - All changes must pass automated review

### Weekly Workflow

1. **Monday**: Dependabot creates dependency update PRs
2. **Tuesday-Thursday**: Automated review and approval process
3. **Friday**: Batch promotion of approved changes to develop
4. **Weekend**: Cleanup of old branches and monitoring

### Emergency Workflow

For urgent fixes:
1. **Manual Override**: Use workflow dispatch to promote specific changes
2. **Hotfix Process**: Create hotfix branch from main, bypass automated review
3. **Post-Emergency**: Review and merge hotfix back to automated-review

## Monitoring Dashboard

### GitHub Actions Tab
- View all workflow runs
- Monitor failure patterns
- Check auto-fix results
- Track automated review progress

### Pull Requests Tab
- Review Dependabot PRs
- Check auto-fix PRs
- Monitor promotion PRs
- Track review status

### Issues Tab
- Persistent failure issues
- Auto-generated maintenance tasks
- Breaking change alerts

## Best Practices

### 1. Review Process
- **Always review** Dependabot PRs before promotion
- **Test changes** in staging before production
- **Monitor breaking changes** carefully
- **Use batch promotion** for efficiency

### 2. Safety Controls
- **Never bypass** the automated-review branch
- **Always test** promoted changes
- **Monitor notifications** for critical issues
- **Review security updates** immediately

### 3. Customization
- **Adjust schedules** based on team needs
- **Modify auto-fix patterns** as requirements change
- **Update review criteria** based on project evolution
- **Fine-tune promotion triggers**

### 4. Troubleshooting
- **Check branch protection** if PRs can't be merged
- **Review workflow logs** for failure analysis
- **Monitor automated-review** branch for issues
- **Use manual promotion** for urgent fixes

## Troubleshooting

### Common Issues

**Dependabot Not Creating PRs**:
- Check repository permissions
- Verify `automated-review` branch exists
- Ensure configuration syntax is correct
- Check if dependencies are in package.json

**Workflow Monitor Not Triggering**:
- Check workflow file syntax
- Verify trigger conditions
- Review GitHub Actions permissions
- Ensure `automated-review` branch exists

**Automated Review Failing**:
- Check test suite status
- Review security audit results
- Verify breaking change detection
- Check branch protection rules

**Cursor Agent Not Working**:
- Ensure Cursor IDE is installed
- Check configuration file syntax
- Verify file permissions
- Confirm `automated-review` branch targeting

### Debug Commands

```bash
# Check branch protection status
gh api repos/:owner/:repo/branches/automated-review/protection

# List workflow runs
gh run list --workflow=automated-review.yml

# Check Dependabot status
gh api repos/:owner/:repo/dependabot/alerts

# List PRs targeting automated-review
gh pr list --base automated-review

# Check Cursor agent logs
# (View in Cursor IDE output panel)
```

## Maintenance

### Daily Tasks
- Review automated-review PRs
- Check workflow failure patterns
- Monitor security alerts
- Test promoted changes

### Weekly Tasks
- Review Dependabot PRs
- Batch promote approved changes
- Clean up old branches
- Update monitoring rules

### Monthly Tasks
- Comprehensive security audit
- Review and update configurations
- Analyze failure trends
- Performance optimization review

### Quarterly Tasks
- Review branch protection rules
- Update automated review criteria
- Security policy review
- Team training on review process

## Related Documentation

- [Dependabot Documentation](https://docs.github.com/en/code-security/dependabot)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)
- [Cursor IDE Documentation](https://cursor.sh/docs)
- [CouncilWorks Development Standards](../../docs/development/developer-brief.md)
- [Security Standards](../../docs/security/rbac-implementation.md)
